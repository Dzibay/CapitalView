# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## –ê–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è)

#### 1. `update_portfolio_values_from_date` - 78.89% –≤—Ä–µ–º–µ–Ω–∏
- **–í—ã–∑–æ–≤–æ–≤**: 1477
- **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è**: 2.76 —Å–µ–∫—É–Ω–¥—ã
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è**: 6.98 —Å–µ–∫—É–Ω–¥—ã
- **–ü—Ä–æ–±–ª–µ–º–∞**: –°–∞–º–∞—è –º–µ–¥–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ—á–µ–Ω—å —á–∞—Å—Ç–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. **–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã** –Ω–∞ —Ç–∞–±–ª–∏—Ü—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ —Ñ—É–Ω–∫—Ü–∏–∏:
   ```sql
   -- –ò–Ω–¥–µ–∫—Å –¥–ª—è portfolio_daily_values
   CREATE INDEX IF NOT EXISTS idx_portfolio_daily_values_portfolio_date 
   ON portfolio_daily_values(portfolio_id, report_date DESC);
   
   -- –ò–Ω–¥–µ–∫—Å –¥–ª—è portfolio_daily_positions
   CREATE INDEX IF NOT EXISTS idx_portfolio_daily_positions_portfolio_date 
   ON portfolio_daily_positions(portfolio_id, tx_date DESC);
   
   -- –ò–Ω–¥–µ–∫—Å –¥–ª—è transactions (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
   CREATE INDEX IF NOT EXISTS idx_transactions_portfolio_asset_date 
   ON transactions(portfolio_asset_id, transaction_date DESC);
   ```

2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞
3. **–ë–∞—Ç—á–∏–Ω–≥** - –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π –≤ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
4. **–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –¥–ª—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

#### 2. `upsert_asset_prices` - 7.09% –≤—Ä–µ–º–µ–Ω–∏
- **–í—ã–∑–æ–≤–æ–≤**: 8117
- **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è**: 45ms (–Ω–æ –º–∞–∫—Å–∏–º—É–º 2.25s)
- **–ü—Ä–æ–±–ª–µ–º–∞**: –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ—á–µ–Ω—å —á–∞—Å—Ç–æ, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑–æ–≤—ã –º–µ–¥–ª–µ–Ω–Ω—ã–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. **–ë–∞—Ç—á–∏–Ω–≥** - –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ upsert –≤ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
2. **–ò–Ω–¥–µ–∫—Å** –Ω–∞ `asset_prices`:
   ```sql
   CREATE INDEX IF NOT EXISTS idx_asset_prices_asset_date 
   ON asset_prices(asset_id, trade_date DESC);
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã** - –≤–æ–∑–º–æ–∂–Ω–æ, –º–Ω–æ–≥–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ upsert –∑–∞–º–µ–¥–ª—è—é—Ç –∑–∞–ø—Ä–æ—Å—ã

### üü° –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 3. `apply_transaction` - 2.89% –≤—Ä–µ–º–µ–Ω–∏
- **–í—ã–∑–æ–≤–æ–≤**: 135
- **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è**: 1.11 —Å–µ–∫—É–Ω–¥—ã
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è**: 3.98 —Å–µ–∫—É–Ω–¥—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –£–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `apply_transactions_batch` –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π - —Ö–æ—Ä–æ—à–æ
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ `fifo_lots`:
   ```sql
   CREATE INDEX IF NOT EXISTS idx_fifo_lots_portfolio_asset_remaining 
   ON fifo_lots(portfolio_asset_id, created_at) 
   WHERE remaining_qty > 0;
   ```

#### 4. `update_asset_latest_prices_batch` - 2.87% –≤—Ä–µ–º–µ–Ω–∏
- **–í—ã–∑–æ–≤–æ–≤**: 114
- **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è**: 1.3 —Å–µ–∫—É–Ω–¥—ã
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è**: 7.42 —Å–µ–∫—É–Ω–¥—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –§—É–Ω–∫—Ü–∏—è —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CTE –∏ –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–µ–π - –≤–æ–∑–º–æ–∂–Ω–æ, —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ –±–∞—Ç—á–∏

#### 5. `get_all_portfolios_with_assets_and_history` - 2.04% –≤—Ä–µ–º–µ–Ω–∏
- **–í—ã–∑–æ–≤–æ–≤**: 536
- **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è**: 197ms
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è**: 2.62 —Å–µ–∫—É–Ω–¥—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `get_dashboard_data_complete` –≤–º–µ—Å—Ç–æ –Ω–µ—ë
2. **–ó–∞–º–µ–Ω–∏—Ç—å** –≤—ã–∑–æ–≤ –≤ `portfolio_service.py:55` –Ω–∞ `get_dashboard_data_complete`
3. **–£–¥–∞–ª–∏—Ç—å** —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ–≤

## –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

```sql
-- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX IF NOT EXISTS idx_portfolio_daily_values_portfolio_date 
ON portfolio_daily_values(portfolio_id, report_date DESC);

CREATE INDEX IF NOT EXISTS idx_portfolio_daily_positions_portfolio_date 
ON portfolio_daily_positions(portfolio_id, tx_date DESC);

CREATE INDEX IF NOT EXISTS idx_transactions_portfolio_asset_date 
ON transactions(portfolio_asset_id, transaction_date DESC);

CREATE INDEX IF NOT EXISTS idx_asset_prices_asset_date 
ON asset_prices(asset_id, trade_date DESC);

CREATE INDEX IF NOT EXISTS idx_fifo_lots_portfolio_asset_remaining 
ON fifo_lots(portfolio_asset_id, created_at) 
WHERE remaining_qty > 0;

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è portfolio_assets
CREATE INDEX IF NOT EXISTS idx_portfolio_assets_portfolio 
ON portfolio_assets(portfolio_id);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è cash_operations (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ)
CREATE INDEX IF NOT EXISTS idx_cash_operations_portfolio_date 
ON cash_operations(portfolio_id, date DESC);
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π

1. **–ë–∞—Ç—á–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π**:
   - –í–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `update_portfolio_values_from_date` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è
   - –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `update_portfolios_values_from_date_batch(p_portfolio_ids bigint[], p_from_date date)`

2. **–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**:
   - –î–ª—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –≤–º–µ—Å—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

3. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `get_reference_data` (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
   - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

1. **–í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** –≤ Supabase
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã** –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã, –ø—Ä–µ–≤—ã—à–∞—é—â–∏–µ –ø–æ—Ä–æ–≥ –≤—Ä–µ–º–µ–Ω–∏
3. **–†–µ–≥—É–ª—è—Ä–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å** —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç** (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –∏–∑ `database/performance_indexes.sql`
   - ‚ö†Ô∏è –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `update_portfolio_values_from_date` (—Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ SQL —Ñ—É–Ω–∫—Ü–∏–∏)
   - ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `get_all_portfolios_with_assets_and_history` (536 –≤—ã–∑–æ–≤–æ–≤)

2. **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç**:
   - –ë–∞—Ç—á–∏–Ω–≥ –¥–ª—è `upsert_asset_prices` (8117 –≤—ã–∑–æ–≤–æ–≤)
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è `update_asset_latest_prices_batch` (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–µ–π)
   - –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ `fifo_lots` (—É–∂–µ –≤–∫–ª—é—á–µ–Ω–æ –≤ performance_indexes.sql)

3. **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç**:
   - –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω)
   - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è

## –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã (5 –º–∏–Ω—É—Ç)
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç—å database/performance_indexes.sql –≤ Supabase SQL Editor
-- –≠—Ç–æ –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–∑—É —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 20-30%
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
- –§—É–Ω–∫—Ü–∏—è `get_all_portfolios_with_assets_and_history` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 536 —Ä–∞–∑
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `portfolio_service.py:55`
- –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≥–¥–µ-—Ç–æ –µ—â–µ, –∏ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `get_dashboard_data_complete`

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–∑–æ–≤–æ–≤ update_portfolio_values_from_date
- –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 1477 —Ä–∞–∑ —Å–æ —Å—Ä–µ–¥–Ω–∏–º –≤—Ä–µ–º–µ–Ω–µ–º 2.76 —Å–µ–∫—É–Ω–¥—ã
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –±–∞—Ç—á–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω)
